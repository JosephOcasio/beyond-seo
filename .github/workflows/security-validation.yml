name: Security Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security-checks:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          coverage: none

      - name: Validate environment configuration
        run: |
          echo "Checking for hardcoded credentials..."
          ! grep -rE 'DB_PASSWORD=(?!%DB_PASSWORD%|"\$|'"'"'|\s*$)' . --include="*.env" --include="*.php" 2>/dev/null
          ! grep -rE 'API.*PASSWORD=(?!%|"\$|'"'"'|\s*$)' . --include="*.env" --include="*.php" 2>/dev/null
          echo "✅ No hardcoded credentials found"

      - name: Scan for exposed secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: Validate APP_DEBUG not in source
        run: |
          echo "Checking for hardcoded APP_DEBUG=true..."
          ! grep -r "APP_DEBUG.*=.*true" app/src app/config languages --include="*.php" --include="*.env" 2>/dev/null
          echo "✅ No hardcoded APP_DEBUG=true found"

      - name: Check for credential leaks in comments
        run: |
          echo "Scanning for credential hints in comments..."
          ! grep -riE "(password|secret|api.?key|token).{0,50}(=|:)" app/src --include="*.php" | grep -v "getEnv\|Config::\|environment" || true
          echo "✅ No obvious credential leaks in comments"

  dependency-security:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Validate Composer files exist
        run: |
          test -f composer.json || echo "ℹ️  composer.json not found (may be using vendor/ directly)"

      - name: Check for outdated dependencies
        continue-on-error: true
        run: |
          if [ -f composer.json ]; then
            php -m | grep -q "sqlite3\|pdo\|json" || echo "⚠️  Required PHP extensions may be missing"
          fi

  lint:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Validate PHP syntax in app/src
        run: |
          find app/src -name '*.php' -print0 | xargs -0 -n1 php -l
          echo "✅ PHP syntax validation passed"

      - name: Validate PHP syntax in inc/
        continue-on-error: true
        run: |
          find inc -name '*.php' -print0 | xargs -0 -n1 php -l
          echo "✅ PHP syntax validation passed (inc/)"
